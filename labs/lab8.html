
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lab 8: Non-volatile Storage &#8212; CSIC30016: Operating System Capstone</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'labs/lab8';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Hardware" href="hardware/index.html" />
    <link rel="prev" title="Lab 7: Virtual File System" href="lab7.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">CSIC30016: Operating System Capstone</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Class:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../class/staff.html">Staff</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab0.html">Lab 0: Environment Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab1.html">Lab 1: Hello World</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2.html">Lab 2: Booting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab3.html">Lab 3: Exception and Interrupt</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab4.html">Lab 4: Allocator</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab5.html">Lab 5: Thread and User Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab6.html">Lab 6: Virtual Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab7.html">Lab 7: Virtual File System</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lab 8: Non-volatile Storage</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="hardware/index.html">Hardware</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="hardware/asm.html">The Assembly You Need</a></li>
<li class="toctree-l2"><a class="reference internal" href="hardware/mailbox.html">Mailbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="hardware/uart.html">UART</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">References:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../references/external_resources.html">External Resourses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/old_course.html">Old Course Websites</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/labs/lab8.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab 8: Non-volatile Storage</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goals-of-this-lab">Goals of this lab</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fat-file-system">FAT File System</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#short-file-names-sfn-and-long-file-names-lfn">Short File Names (SFN) and Long File Names (LFN)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sd-card">SD Card</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sd-card-driver">SD Card Driver</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sd-card-on-qemu">SD Card on QEMU</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sd-card-on-linux">SD Card on Linux</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sector">Sector</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#block">Block</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster">Cluster</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-exercises">Basic Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-partition">Get Partition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mount-fat32">Mount FAT32</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-exercise-1-open-and-read-40">Basic Exercise 1 - Open and Read - 40%</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lookup-and-open">Lookup and Open</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#read">Read</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-exercise-2-create-and-write-30">Basic Exercise 2 - Create and Write - 30%</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create">Create</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#write">Write</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-exercises">Advanced Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-exercise-1-memory-cached-sd-card-40">Advanced Exercise 1 - Memory Cached SD Card - 40%</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#file-metadata">File Metadata</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-entry">Directory Entry</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#file-content">File Content</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sync">Sync</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test">Test</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="lab-8-non-volatile-storage">
<h1>Lab 8: Non-volatile Storage<a class="headerlink" href="#lab-8-non-volatile-storage" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>In previous lab, files were stored in memory, which is volatile.
In this lab, you’ll implement FAT32 that stores data in SD card.</p>
</section>
<section id="goals-of-this-lab">
<h2>Goals of this lab<a class="headerlink" href="#goals-of-this-lab" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Understand how to interact with SD card.</p></li>
<li><p>Implement FAT32 file system.</p></li>
<li><p>Understand memory cache for slow storage mediums.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It’s better to do this lab on qemu first, and backup your SD card as disk image when you run on real SD card,
so you can <code class="docutils literal notranslate"><span class="pre">dd</span></code> to restore if you broke your FAT32 partition</p>
</div>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<section id="fat-file-system">
<h3>FAT File System<a class="headerlink" href="#fat-file-system" title="Link to this heading">#</a></h3>
<p>FAT is a simple and widely used file system.
There is at least one file allocation table, which stores the allocation status.
The entry size can be either 12 bit, 16 bit, or 32 bit.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>FAT is a portable file system, hence, your FAT32 driver should be compatible with others.</p>
</div>
</section>
<section id="short-file-names-sfn-and-long-file-names-lfn">
<h3>Short File Names (SFN) and Long File Names (LFN)<a class="headerlink" href="#short-file-names-sfn-and-long-file-names-lfn" title="Link to this heading">#</a></h3>
<p>Originally, FAT uses 8 bytes to store file name and 3 bytes to store extension name,
for example: <code class="docutils literal notranslate"><span class="pre">&quot;a.out&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;a&quot;</span></code> stored in the file name, <code class="docutils literal notranslate"><span class="pre">&quot;out&quot;</span></code> stored in extension name and <code class="docutils literal notranslate"><span class="pre">&quot;.&quot;</span></code> is ignored.</p>
<p>However, it limits the file name’s length and encoding, hence, LFN was invented to fix this problem.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">nctuos.img</span></code> we provide in lab0 is using LFN,
so we provide a new <a class="reference external" href="https://github.com/GrassLab/osdi/raw/master/supplement/sfn_nctuos.img">sfn_nctuos.img</a> ,
which is using SFN, and the <code class="docutils literal notranslate"><span class="pre">kernel8.img</span></code> inside prints out the first block
and the first partition block of the SD card.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SFN is easier to implement than LFN, you can choose either one to implement.
We won’t test against LFN, but you might need to change your configuration to use SFN.
Ex. initramfs.cpio needs to be renamed, and modify config.txt so bootloader can load it.</p>
</div>
</section>
<section id="sd-card">
<h3>SD Card<a class="headerlink" href="#sd-card" title="Link to this heading">#</a></h3>
<section id="sd-card-driver">
<h4>SD Card Driver<a class="headerlink" href="#sd-card-driver" title="Link to this heading">#</a></h4>
<p>We provide an <a class="reference external" href="https://github.com/GrassLab/osdi/raw/master/supplement/sdhost.c">SD card driver</a> for you.</p>
<p>You should first call the <code class="docutils literal notranslate"><span class="pre">sd_init</span></code> to initialize the SD card.
Then you can use <code class="docutils literal notranslate"><span class="pre">readblock</span></code> / <code class="docutils literal notranslate"><span class="pre">writeblock</span></code> to R/W 512 bytes from/to SD card.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You should modify the code to meet your requirements.</p>
</div>
</section>
<section id="sd-card-on-qemu">
<h4>SD Card on QEMU<a class="headerlink" href="#sd-card-on-qemu" title="Link to this heading">#</a></h4>
<p>You can add the argument <code class="docutils literal notranslate"><span class="pre">-drive</span> <span class="pre">if=sd,file=&lt;img&gt;,format=raw</span></code> to attach an disk image to QEMU.</p>
</section>
<section id="sd-card-on-linux">
<h4>SD Card on Linux<a class="headerlink" href="#sd-card-on-linux" title="Link to this heading">#</a></h4>
<p>In Linux, you can set up a loop device for a disk image.</p>
<p><code class="docutils literal notranslate"><span class="pre">losetup</span> <span class="pre">-fP</span> <span class="pre">&lt;img&gt;</span></code>: set up a loop device for disk image,
you can use <code class="docutils literal notranslate"><span class="pre">lsblk</span></code> to lookup which loop device it’s attached to</p>
<p><code class="docutils literal notranslate"><span class="pre">losetup</span> <span class="pre">-d</span> <span class="pre">&lt;device&gt;</span></code>: detach the loop device from the disk image.</p>
<p>Then you can mount loop device</p>
<p><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">-t</span> <span class="pre">msdos</span> <span class="pre">&lt;device&gt;</span> <span class="pre">&lt;dir&gt;</span></code>: SFN.</p>
<p><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">-t</span> <span class="pre">vfat</span> <span class="pre">&lt;device&gt;</span> <span class="pre">&lt;dir&gt;</span></code>: LFN.</p>
</section>
<section id="sector">
<h4>Sector<a class="headerlink" href="#sector" title="Link to this heading">#</a></h4>
<p>A sector is the smallest unit for a hard drive to manage its data.</p>
</section>
<section id="block">
<h4>Block<a class="headerlink" href="#block" title="Link to this heading">#</a></h4>
<p>A block is the smallest unit for a block device driver to read/write a device.</p>
</section>
<section id="cluster">
<h4>Cluster<a class="headerlink" href="#cluster" title="Link to this heading">#</a></h4>
<p>A cluster is composed of contiguous blocks.
A file system uses it as a basic unit to store a regular file or a directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use the provided image and driver, sector, block, and cluster are all 512 bytes.</p>
</div>
</section>
</section>
</section>
<section id="basic-exercises">
<h2>Basic Exercises<a class="headerlink" href="#basic-exercises" title="Link to this heading">#</a></h2>
<p>In this part, you should mount SD Card’s FAT32 partition on <code class="docutils literal notranslate"><span class="pre">/boot</span></code>.</p>
<section id="get-partition">
<h3>Get Partition<a class="headerlink" href="#get-partition" title="Link to this heading">#</a></h3>
<p>You should locate the partition before mount.
SD card was formatted as MBR (normally).
You can parse it to get each partition’s type, size, and block index.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use the provided image, the FAT32 partition’s block index is 2048.</p>
</div>
</section>
<section id="mount-fat32">
<h3>Mount FAT32<a class="headerlink" href="#mount-fat32" title="Link to this heading">#</a></h3>
<p>FAT32 stores its metadata in the first sector of the partition.
You need to do the following things during mounting.</p>
<ol class="arabic simple">
<li><p>Parse the metadata on the SD card.</p></li>
<li><p>Create a kernel object to store the metadata in memory.</p></li>
<li><p>Get the root directory cluster number and create it’s root directory object.</p></li>
</ol>
</section>
<section id="basic-exercise-1-open-and-read-40">
<h3>Basic Exercise 1 - Open and Read - 40%<a class="headerlink" href="#basic-exercise-1-open-and-read-40" title="Link to this heading">#</a></h3>
<p>In this part, you need to lookup, open, and read existing files in FAT32.</p>
<section id="lookup-and-open">
<h4>Lookup and Open<a class="headerlink" href="#lookup-and-open" title="Link to this heading">#</a></h4>
<p>To look up files in FAT32 directory.</p>
<ol class="arabic simple">
<li><p>Get the cluster number of the directory and calculate its block index.</p></li>
<li><p>Read the first block of the cluster.</p></li>
<li><p>Traverse the directory entries to find the file.</p></li>
</ol>
<p>You can get the first cluster number of the file in the directory entry.</p>
</section>
<section id="read">
<h4>Read<a class="headerlink" href="#read" title="Link to this heading">#</a></h4>
<p>After you get the first cluster number of the file, you can use readblock to read the file.</p>
</section>
</section>
<section id="basic-exercise-2-create-and-write-30">
<h3>Basic Exercise 2 - Create and Write - 30%<a class="headerlink" href="#basic-exercise-2-create-and-write-30" title="Link to this heading">#</a></h3>
<p>In this part, you need to create, and write files in FAT32.</p>
<section id="create">
<h4>Create<a class="headerlink" href="#create" title="Link to this heading">#</a></h4>
<p>To create a new file in FAT32</p>
<ol class="arabic simple">
<li><p>Find an empty entry in the FAT table.</p></li>
<li><p>Find an empty directory entry in the target directory.</p></li>
<li><p>Set them to proper values.</p></li>
</ol>
</section>
<section id="write">
<h4>Write<a class="headerlink" href="#write" title="Link to this heading">#</a></h4>
<p>Similar to read, you can use writeblock to write file, you also need to maintain the metadata of file.</p>
</section>
</section>
</section>
<section id="advanced-exercises">
<h2>Advanced Exercises<a class="headerlink" href="#advanced-exercises" title="Link to this heading">#</a></h2>
<p>In this part, you create an cache layer for your SD card.</p>
<section id="advanced-exercise-1-memory-cached-sd-card-40">
<h3>Advanced Exercise 1 - Memory Cached SD Card - 40%<a class="headerlink" href="#advanced-exercise-1-memory-cached-sd-card-40" title="Link to this heading">#</a></h3>
<p>Accessing an SD card is much slower than accessing memory.
Before a CPU shutdown or an SD card ejected, it is not necessary to synchronize the data between memory and SD card.
Hence, it’s more efficient to preserve the data in memory and use memory as a cache for external storage.</p>
<p>We can categorize the file data on the storage into three types: file content, directory entry, and file metadata.</p>
<section id="file-metadata">
<h4>File Metadata<a class="headerlink" href="#file-metadata" title="Link to this heading">#</a></h4>
<p>Besides the content of a file, additional information such as file size is stored in external storage, too.
The additional information is the file’s metadata. There is also metadata for a file system such as FAT tables in FAT.</p>
<p>Those metadata are cached by a file system’s kernel objects.</p>
</section>
<section id="directory-entry">
<h4>Directory Entry<a class="headerlink" href="#directory-entry" title="Link to this heading">#</a></h4>
<p>VFS can reduce the time spend on reading directory block and parsing directory entry by a component name cache mechanism.
A component name cache mechanism can be implemented as:</p>
<ol class="arabic simple">
<li><p>Look up the component name cache of the directory first.</p></li>
<li><p>If successfully finds the vnode, return to the vnode. Otherwise, call the lookup method of the underlying file system.</p></li>
<li><p>The underlying file system looks up from external storage.</p></li>
<li><p>If it successfully finds the file, it creates a vnode for the file and put it into the component name cache.</p></li>
</ol>
</section>
<section id="file-content">
<h4>File Content<a class="headerlink" href="#file-content" title="Link to this heading">#</a></h4>
<p>A VFS can cache file content in memory by page frames. A page cache mechanism can be implemented as:</p>
<ol class="arabic simple">
<li><p>Check the existence of the file’s page frames when read or write a file.</p></li>
<li><p>If the page frames don’t exist, allocate page frames for the file.</p></li>
<li><p>The underlying file system populates the page frames with the file’s content in external storage if necessary.</p></li>
</ol>
<p>Read or write the page frames of the file.</p>
</section>
<section id="sync">
<h4>Sync<a class="headerlink" href="#sync" title="Link to this heading">#</a></h4>
<p>VFS should synchronize the file’s memory cache with the external storage when a user wants to eject it.
Hence, a VFS should provide an API for users to synchronize the data, and the file system should implement
the synchronize method for writing data back to the external storage.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// syscall number 20</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sync</span><span class="p">();</span>
<span class="c1">// this should call VFS api to sync</span>
<span class="c1">// usually it&#39;s calling super_operation sync_fs on all file system</span>
<span class="c1">// but we don&#39;t care how you design it, as long as it syncs.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You shouldn’t write to SD card until sync is called.
Ex. open() -&gt; write() -&gt; close() -&gt; poweroff
shouldn’t create a file on SD card.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Although normally, filesystem are cached differently for different components (so it’s possible to partial sync).
But we only test against full synchronization, so it is possible to cache at block level.
which means, all block read and write goes through cache layer, and dirty blocks are written back to SD card when synced.</p>
</div>
</section>
</section>
<section id="test">
<h3>Test<a class="headerlink" href="#test" title="Link to this heading">#</a></h3>
<p>Put <a class="reference download internal" download="" href="../_downloads/4ee703906d67d0333ef4c215dc060ab3/vfs2.img"><code class="xref download docutils literal notranslate"><span class="pre">vfs2.img</span></code></a> in initramfs.cpio</p>
<p>Put <a class="reference download internal" download="" href="../_downloads/10fbdc3e04b471849e714edcdcf4ce26/FAT_R.TXT"><code class="xref download docutils literal notranslate"><span class="pre">FAT_R.TXT</span></code></a> in your sd card</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>normally for case insensitive file system, the file system driver does case insensitive lookup.
But for your convenience, all filenames we use in FAT32 are upper case.</p>
</div>
<ul class="simple">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">fat_r</span></code> for Basic Exercise 1</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">fat_w</span></code> for Basic Exercise 2</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">fat_ws</span></code> for Advanced Exercise 1</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>you should check your sd card with your computer.
For <code class="docutils literal notranslate"><span class="pre">fat_w</span></code> there should be <code class="docutils literal notranslate"><span class="pre">FAT_W.TXT</span></code>.
For <code class="docutils literal notranslate"><span class="pre">fat_ws</span></code> there should be <code class="docutils literal notranslate"><span class="pre">FAT_WS.TXT</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’ve implement advance exercise 1, run <code class="docutils literal notranslate"><span class="pre">fat_ws</span></code> before <code class="docutils literal notranslate"><span class="pre">fat_w</span></code> and then power off.
There should be <code class="docutils literal notranslate"><span class="pre">FAT_WS.TXT</span></code> but not <code class="docutils literal notranslate"><span class="pre">FAT_W.TXT</span></code></p>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lab7.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lab 7: Virtual File System</p>
      </div>
    </a>
    <a class="right-next"
       href="hardware/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Hardware</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goals-of-this-lab">Goals of this lab</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fat-file-system">FAT File System</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#short-file-names-sfn-and-long-file-names-lfn">Short File Names (SFN) and Long File Names (LFN)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sd-card">SD Card</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sd-card-driver">SD Card Driver</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sd-card-on-qemu">SD Card on QEMU</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sd-card-on-linux">SD Card on Linux</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sector">Sector</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#block">Block</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster">Cluster</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-exercises">Basic Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-partition">Get Partition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mount-fat32">Mount FAT32</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-exercise-1-open-and-read-40">Basic Exercise 1 - Open and Read - 40%</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lookup-and-open">Lookup and Open</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#read">Read</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-exercise-2-create-and-write-30">Basic Exercise 2 - Create and Write - 30%</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create">Create</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#write">Write</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-exercises">Advanced Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-exercise-1-memory-cached-sd-card-40">Advanced Exercise 1 - Memory Cached SD Card - 40%</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#file-metadata">File Metadata</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-entry">Directory Entry</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#file-content">File Content</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sync">Sync</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test">Test</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By  NYCU cas-lab
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, NYCU cas-lab.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>